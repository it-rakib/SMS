@model IEnumerable<dynamic>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<h4 class="text-center">Inventory Report (@DateTime.Now.Year)</h4>

<form method="get" class="row mb-3">
    <div class="col-md-3">
        <select name="productId" class="form-control">
            <option value="">-- All Products --</option>
            @foreach (var p in ViewBag.Products)
            {
                <option value="@p.ProductId"
                        selected="@(ViewBag.SelectedProductId == p.ProductId)">
                    @p.ProductName
                </option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <select name="month" class="form-control">
            <option value="">-- All Months --</option>
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m" selected="@(ViewBag.SelectedMonth == m)">
                    @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)
                </option>
            }
        </select>
    </div>

    <div class="col-md-2">
        <button class="btn btn-primary">Search</button>
    </div>
</form>
<div class="mb-3">
    <button type="button" class="btn btn-success" onclick="printReport()">Print / PDF</button>
    <button type="button" class="btn btn-warning" onclick="exportTableToExcel('inventoryTable', 'InventoryReport')">Download Excel</button>
</div>

<table id="inventoryTable" class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Product</th>
            <th>Month</th>
            <th>Purchased</th>
            <th>Sold</th>
            <th>Closing Stock</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.ProductName</td>
                <td>@item.MonthName</td>
                <td class="text-end">@item.PurchasedQty</td>
                <td class="text-end">@item.SoldQty</td>
                <td class="text-end fw-bold">@item.ClosingStock</td>
            </tr>
        }
    </tbody>
</table>


<script>
    function exportTableToExcel(tableID, filename = ''){
        var downloadLink;
        var dataType = 'application/vnd.ms-excel';
        var tableSelect = document.getElementById(tableID);
        var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

        filename = filename?filename+'.xls':'excel_data.xls';

        downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);

        if(navigator.msSaveOrOpenBlob){
            var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
            downloadLink.download = filename;
            downloadLink.click();
        }
    }
        function printReport() {
        var table = document.getElementById('inventoryTable');

        html2canvas(table).then(canvas => {
            var imgData = canvas.toDataURL('image/png');
            var pdf = new jspdf.jsPDF('p', 'pt', 'a4');
            var pageWidth = pdf.internal.pageSize.getWidth();
            var pageHeight = pdf.internal.pageSize.getHeight();
            var imgWidth = pageWidth - 40; // margins
            var imgHeight = canvas.height * imgWidth / canvas.width;
            pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
            pdf.save('InventoryReport.pdf');
        });
    }
</script>

